name: Deploy to EC2

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout your code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Deploy to EC2
      - name: Deploy to EC2
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          EC2_INSTANCE_IP: ${{ secrets.EC2_INSTANCE_IP }}
        run: |
          echo -e "$SSH_PRIVATE_KEY" > private_key.pem
          chmod 600 private_key.pem
          ssh -i private_key.pem -o StrictHostKeyChecking=no ubuntu@$EC2_INSTANCE_IP << EOF
            echo "Connected to EC2"

            # Install Git if not present
            if ! command -v git >/dev/null 2>&1; then
              echo "Installing Git..."
              sudo apt-get update -y
              sudo apt-get install -y git
            fi

            # Install Docker if not present
            if ! command -v docker >/dev/null 2>&1; then
              echo "Installing Docker..."
              sudo apt-get install -y docker.io
              sudo systemctl start docker
              sudo systemctl enable docker
              sudo usermod -aG docker ubuntu
            fi

            # Install Docker Compose if not present
            if ! command -v docker-compose >/dev/null 2>&1; then
              echo "Installing Docker Compose..."
              sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-\$(uname -s)-\$(uname -m)" -o /usr/local/bin/docker-compose
              sudo chmod +x /usr/local/bin/docker-compose
            fi

            # Clone or update the repo
            if [ -d "/home/ubuntu/telemetry-v02" ]; then
              echo "Updating existing repo..."
              cd /home/ubuntu/telemetry-v02
              git pull origin main
            else
              echo "Cloning repo..."
              git clone https://github.com/Augustine423/telemetry-v02.git /home/ubuntu/telemetry-v02
              cd /home/ubuntu/telemetry-v02
            fi

            # Login to Docker Hub (if your docker-compose.yaml uses private images)
            echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
            echo "Logged into Docker Hub"

            # Build and deploy using existing Dockerfile and docker-compose.yaml
            echo "Building and deploying..."
            docker-compose up -d --build

            # Show running containers
            echo "Running containers:"
            docker ps
          EOF
          rm -f private_key.pem